<!doctype html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title> 
 
</head>
<body>
 <script src="https://unpkg.com/@supabase/supabase-js"></script>
    <script>
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const SUPABASE_URL = "https://pgdtypgzzdchqefcgcaz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBnZHR5cGd6emRjaHFlZmNnY2F6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1MjAxNzEsImV4cCI6MjA3NDA5NjE3MX0.a0VHx01HJRa6G3MGTzR3pLHRjNr1cUiaiENOwWicizc";

    async function zapisDoTabulky() {
        const { data, error } = await supabaseClient
        .from('users')                // ⬅ sem název tabulky
        .insert([
            { token_count:"4" , email: 'gg@wtf.com' }  // ⬅ sem sloupce a hodnoty
        ]);

        console.log('data:', data);
        console.log('error:', error);
    } // zavřeme funkci
    zapisDoTabulky(); // funkci rovnou zavoláme
    </script>
    </body>
</html

<script>
    const SUPABASE_URL = "https://pgdtypgzzdchqefcgcaz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBnZHR5cGd6emRjaHFlZmNnY2F6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1MjAxNzEsImV4cCI6MjA3NDA5NjE3MX0.a0VHx01HJRa6G3MGTzR3pLHRjNr1cUiaiENOwWicizc";

    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const emailEl = document.getElementById("email");
    const token_count = document.getElementById("token_count");
    const btnQR = document.getElementById("generate-qr");
    const qrContainer = document.getElementById("qr-container");

    // === Funkce na generování temp key ===
    function generateTempKey(length = 48) {
        const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_-+=";
        let out = "";
        for (let i = 0; i < length; i++) out += chars.charAt(Math.floor(Math.random() * chars.length));
        return out;
    }

    // === Načtení uživatele + generování temporary_key ===
    let currentUserRow = null;

    async function loadUser() {
        const { data: userData } = await supabaseClient.auth.getUser();

        if (!userData.user) {
            window.location.href = "index.html";
            return;
        }

        const email = userData.user.email;
        emailEl.textContent = email;

        const newKey = generateTempKey();

        // --- najít uživatele podle emailu ---
        const { data: existing } = await supabaseClient
            .from("users")
            .select("id, token_count, temporary_key")
            .eq("email", email)
            .maybeSingle();

        if (existing) {
            // update temporary_key
            await supabaseClient
                .from("users")
                .update({ temporary_key: newKey })
                .eq("email", email);

            currentUserRow = {
                id: existing.id,
                email: email,
                token_count: existing.token_count,
                temporary_key: newKey
            };

            token_countEl.textContent = existing.token_count + " tokenů";
            return;
        }

        // pokud neexistuje → vytvořit
        const { data: inserted } = await supabaseClient
            .from("users")
            .insert([{ 
                email: email, 
                token_count: 0,
                temporary_key: newKey
            }])
            .select()
            .single();

        currentUserRow = inserted;
        token_countEl.textContent = inserted.token_count + " tokenů";
    }

    loadUser();

    // === Generování QR kódu ===
    btnQR.addEventListener("click", async () => {

        if (!currentUserRow) {
            console.error("Uživatel ještě není načten!");
            return;
        }

        qrContainer.innerHTML = ""; // reset

        // Data, která se zakódují do QR
        const qrData = JSON.stringify({
            id: currentUserRow.id,
            temporary_key: currentUserRow.temporary_key
        });

        // Vygenerování QR
        QRCode.toCanvas(qrData, { width: 220 }, (err, canvas) => {
            if (err) {
                console.error("Chyba QR:", err);
                return;
            }
            qrContainer.appendChild(canvas);
        });
    });
</script>
