<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Supabase Google Sign-In (example)</title>
<style>
body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding: 2rem; }
button { padding: .6rem 1rem; border-radius: 8px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
.info { margin-top: 1rem; }
pre { background:#f6f6f6; padding:1rem; border-radius:8px; }
</style>
</head>
<body>
  <h1>Supabase Google Sign-In — jednoduchý příklad</h1>
  <p>Tlačítko se přihlásí přes Google. Pokud neexistuje záznam v tabulce <code>users</code> (sloupce <code>email</code> a <code>gid</code>), automaticky se vytvoří.</p>

  <button id="btn-google">Přihlásit se pomocí Google</button>

  <div class="info" id="status">Status: čekám na akci uživatele...</div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script>
    // === NASTAVTE TADY ===
    const SUPABASE_URL = "https://pgdtypgzzdchqefcgcaz.supabase.co"; // <- nahraďte
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBnZHR5cGd6emRjaHFlZmNnY2F6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1MjAxNzEsImV4cCI6MjA3NDA5NjE3MX0.a0VHx01HJRa6G3MGTzR3pLHRjNr1cUiaiENOwWicizc"; // <- nahraďte
    // =====================

    const { createClient } = supabase; // UMD export
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const statusEl = document.getElementById('status');
    const btn = document.getElementById('btn-google');

    function setStatus(html){ statusEl.innerHTML = `Status: ${html}`; }

    // --- klik na tlačítko - zahájit OAuth flow ---
    btn.addEventListener('click', async () => {
      setStatus('Otevírám Google přihlášení...');
      const { error } = await supabaseClient.auth.signInWithOAuth({
        provider: 'google',
        options: { redirectTo: hogofogo.netlify.app }
      });
      if (error) setStatus('Chyba při zahájení OAuth: ' + error.message);
    });

    // --- zkontrolujeme, jestli už je uživatel přihlášen ---
    // spustíme na načtení i po redirectu
    window.addEventListener('load', checkAndSyncUser);

    // Hlavní funkce: ověří existenci v tabulce `users` a případně vloží nový záznam
    async function checkAndSyncUser(){
      setStatus('Kontroluji session...');

      // doporučený způsob: getUser() (provede síťový request)
      const { data: userData, error: getUserError } = await supabaseClient.auth.getUser();
      if (getUserError) {
        setStatus('Chyba při získání uživatele: ' + getUserError.message);
        return;
      }

      const user = userData?.user;
      if (!user) {
        setStatus('Není přihlášen žádný uživatel.');
        return;
      }

      setStatus('Přihlášen: ' + (user.email || user.id) + ' — zjišťuji identity...');

      // získat linked identities — obsahuje provider_id (to je Google ID) a provider
      const { data: identitiesData, error: idErr } = await supabaseClient.auth.getUserIdentities();
      if (idErr) {
        setStatus('Chyba při získání identities: ' + idErr.message);
        return;
      }

      const identities = identitiesData?.data || [];
      // najdeme identity s provider === 'google'
      const googleIdentity = identities.find(i => i.provider === 'google');
      if (!googleIdentity) {
        // uživatel je přihlášen, ale ne Google (může být email/password) — upravte podle potřeby
        setStatus('Uživatel není přihlášen přes Google (provider != google). Email: ' + (user.email || 'n/a'));
        return;
      }

      // provider_id je ID od Google (to chceme uložit do sloupce `gid`)
      const providerId = googleIdentity.provider_id;
      const email = googleIdentity.email || user.email;

      setStatus('Google ID: ' + providerId + ' — kontrola v tabulce users...');

      // 1) zkontrolujeme, jestli už máme uživatele v tabulce 'users' podle gid (nebo emailu)
      const { data: existing, error: selectErr } = await supabaseClient
        .from('users')
        .select('id, email, gid')
        .or(`gid.eq.${providerId},email.eq.${email}`)
        .limit(1)
        .maybeSingle();

      if (selectErr) {
        setStatus('Chyba při dotazu do tabulky users: ' + selectErr.message);
        return;
      }

      if (existing) {
        setStatus('Uživatel nalezen v users (id=' + existing.id + '). Přihlášení dokončeno.');
        // tady můžete přesměrovat na zamýšlenou stránku
        return;
      }

      // 2) pokud neexistuje, vložíme nový záznam
      setStatus('Uživatel nenalezen — vytvářím záznam v users...');
      const insertPayload = { email: email, gid: providerId };
      const { data: inserted, error: insertErr } = await supabaseClient
        .from('users')
        .insert([insertPayload])
        .select()
        .single();

      if (insertErr) {
        setStatus('Chyba při vytváření uživatele v users: ' + insertErr.message + '. Zkontrolujte RLS/povolení.');
        return;
      }

      setStatus('Nový uživatel vytvořen (users.id=' + inserted.id + '). Přihlášení dokončeno.');
      // ...a dál co potřebujete (redirect, zobrazení uživatele apod.)
    }

    // Volitelně nasloucháme změnám stavu autentizace (užitečné pro SPA flow bez redirectu)
    supabaseClient.auth.onAuthStateChange((event, session) => {
      console.log('auth state change', event, session);
      if (event === 'SIGNED_IN') {
        // po sign-inu zkusíme synchronizovat tabulku
        checkAndSyncUser();
      }
      if (event === 'SIGNED_OUT') {
        setStatus('Uživatel odhlášen.');
      }
    });

  </script>
</body>
</html>
