<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kup si svou propisku – přihlášení</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="pics/pen.png">
 
</head>
<body>
  <h1>S námi budete vždy připraveni na nečekané testy</h1>
  <p>Nová propiska se může hodit vždy, ať už se Vám Vaše rozbila, přestala psát nebo jste ji někde ztratily. Ale nezoufejte.<br>Právě proto jsme tady.</p>
  <button id="btn-google">Jdu si pro mou propisku</button>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script>
    const SUPABASE_URL = "https://pgdtypgzzdchqefcgcaz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBnZHR5cGd6emRjaHFlZmNnY2F6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1MjAxNzEsImV4cCI6MjA3NDA5NjE3MX0.a0VHx01HJRa6G3MGTzR3pLHRjNr1cUiaiENOwWicizc";

    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const btn = document.getElementById('btn-google');

    function logStatus(msg) {
      console.log(`[AUTH STATUS] ${msg}`);
    }

    btn.addEventListener('click', async () => {
      logStatus('Otevírám Google přihlášení...');
      const { error } = await supabaseClient.auth.signInWithOAuth({
        provider: 'google',
        options: { redirectTo: "https://hogofogo.netlify.app/" }
      });
      if (error) logStatus('Chyba při zahájení OAuth: ' + error.message);
    });

    window.addEventListener('load', checkAndSyncUser);

    async function checkAndSyncUser() {
      logStatus('Kontroluji session...');
      const { data: userData, error: getUserError } = await supabaseClient.auth.getUser();
      if (getUserError) return logStatus('Chyba při získání uživatele: ' + getUserError.message);

      const user = userData?.user;
      if (!user) return logStatus('Není přihlášen žádný uživatel.');

      logStatus('Přihlášen: ' + (user.email || user.id));

      const { data: identitiesData, error: idErr } = await supabaseClient.auth.getUserIdentities();
      if (idErr) return logStatus('Chyba při získání identities: ' + idErr.message);

      const googleIdentity = identitiesData?.data?.find(i => i.provider === 'google');
      if (!googleIdentity) return logStatus('Uživatel není přihlášen přes Google.');

      const providerId = googleIdentity.provider_id;
      const email = googleIdentity.email || user.email;

      logStatus('Kontrola uživatele v tabulce users...');
      const { data: existing, error: selectErr } = await supabaseClient
        .from('users')
        .select('id, email, gid')
        .or(`gid.eq.${providerId},email.eq.${email}`)
        .limit(1)
        .maybeSingle();

      if (selectErr) return logStatus('Chyba při dotazu do tabulky users: ' + selectErr.message);
      if (existing) return logStatus(`Uživatel nalezen (id=${existing.id}).`);

      logStatus('Vytvářím nový záznam...');
      const insertPayload = { email: email, gid: providerId };
      const { data: inserted, error: insertErr } = await supabaseClient
        .from('users')
        .insert([insertPayload])
        .select()
        .single();

      if (insertErr) return logStatus('Chyba při vytváření uživatele: ' + insertErr.message);

      logStatus('Nový uživatel vytvořen (id=' + inserted.id + ').');
    }

    supabaseClient.auth.onAuthStateChange((event, session) => {
      console.log('Auth state change:', event);
      if (event === 'SIGNED_IN') checkAndSyncUser();
      if (event === 'SIGNED_OUT') logStatus('Uživatel odhlášen.');
    });
  </script>
</body>
</html>
