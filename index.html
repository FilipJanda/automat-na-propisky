<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Google Sign-In (GIS) ukázka</title>
  <meta name="google-signin-client_id" content="1047869218898-7f4v8h7stuu1v3k0u2tvhnm4sujsjgmp.apps.googleusercontent.com">
  <style>
    body{font-family:system-ui,Arial;margin:32px}
    .card{max-width:540px;margin:0 auto}
    #user-info{margin-top:18px;border-top:1px solid #eee;padding-top:12px}
    img.profile{width:96px;height:96px;border-radius:50%;object-fit:cover}
    button{margin-top:8px;padding:8px 12px;border-radius:6px;border:1px solid #ccc;background:#f7f7f7;cursor:pointer}
  </style>
</head>
<body>
  <div class="card">
    <h1>Google Sign-In (GIS)</h1>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <div id="g_id_onload" data-client_id="1047869218898-7f4v8h7stuu1v3k0u2tvhnm4sujsjgmp.apps.googleusercontent.com" data-auto_prompt="false"></div>
    <div id="buttonDiv"></div>
    <div id="user-info" aria-live="polite"></div>
  </div>
  <div id="user-list"></div>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script>
  const { createClient } = supabase;
  const supabaseClient = createClient(
      'https://pgdtypgzzdchqefcgcaz.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBnZHR5cGd6emRjaHFlZmNnY2F6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1MjAxNzEsImV4cCI6MjA3NDA5NjE3MX0.a0VHx01HJRa6G3MGTzR3pLHRjNr1cUiaiENOwWicizc'
  );

  async function zapisDoTabulky(userid, usere_mail) {
      const id = String(esc(payload.sub));
      const email = String(esc(payload.email);
      try {
        // 1) zkusíme zjistit, jestli uživatel existuje
        const { data: existing, error: selectErr } = await supabaseClient
          .from('users')
          .select('id,email')
          .eq('id', id)
          .limit(1);
        if (selectErr) {
          console.error('Chyba při kontroli existence uživatele:', selectErr);
        }

        if (existing && existing.length) {
          console.log('Uživatel už existuje v DB:', existing[0]);
          // pokud se e‑mail změnil, aktualizujeme ho
          if (existing[0].email !== email) {
            const { data: updateData, error: updateErr } = await supabaseClient
              .from('users')
              .update({ email })
              .eq('id', id)
              .select();
            console.log('Aktualizace uživatele — data:', updateData, 'chyba:', updateErr);
          }
          return;
        }

        // 2) pokud neexistuje — vložíme
        const { data, error } = await supabaseClient
          .from('users')
          .insert([{ id, email }])
          .select(); // vrať vložený řádek pro lepší debug

        console.log('Insert — data:', data, 'error:', error);
        if (error) console.error('Insert error detail:', error);
      } catch (e) {
        console.error('Neočekávaná chyba při zápisu do DB:', e);
      }
    }
  </script>
  <script>
    function handleCredentialResponse(response) {
      const payload = parseJwt(response.credential);
      const html = `
        <h2>Přihlašovací údaje</h2>
        <p><strong>ID (sub):</strong> ${esc(payload.sub)}</p>
        <p><strong>Jméno:</strong> ${esc(payload.name || '—')}</p>
        <p><strong>Email:</strong> ${esc(payload.email || '—')}</p>
        ${payload.picture ? `<img class="profile" src="${esc(payload.picture)}" alt="Profilová fotka">` : ''}
        <div><button id="signout">Odhlásit</button></div>
      `;
      document.getElementById('user-info').innerHTML = html;
      zapisDoTabulky(String(payload.sub), payload.email);
      document.getElementById('signout').addEventListener('click', () => {
        document.getElementById('user-info').innerHTML = '<p>Uživatel odhlášen.</p>';
        google.accounts.id.disableAutoSelect();
      });
      console.log('Payload:', payload);
    }

    window.onload = function() {
      if (window.google && google.accounts && google.accounts.id) {
        google.accounts.id.initialize({
          client_id: document.querySelector('meta[name="google-signin-client_id"]').content,
          callback: handleCredentialResponse
        });
        google.accounts.id.renderButton(
          document.getElementById('buttonDiv'),
          { theme: 'outline', size: 'large' }
        );
      } else {
        document.getElementById('buttonDiv').innerText = 'Nepodařilo se načíst Google knihovnu.';
      }
    };

    function parseJwt (token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
      } catch(e) { return {}; }
    }

    function esc(s){ if(!s && s !== 0) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
  </script>
</body>
</html>
