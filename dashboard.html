<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard – Propisky</title>
  <link rel="icon" type="image/png" href="pics/pen.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styledashboard.css">
</head>

<body>
   <div class="dashboard">

    <!-- HEADER -->
    <header class="top-bar">
      <div class="tokens" id="token_count">– tokenů</div>
      <div class="user" id="email">Načítám…</div>
      <button class="buy-btn">Koupit tokeny</button>
    </header>

    <!-- MAIN -->
    <main class="main-content">
        <button class="continue-btn" onclick="window.location.href='help.html'">Jak na to</button>
      <button id="generate-qr" class="qr-btn">Generovat QR kód</button>
      <div id="qr-container" class="qr-box"></div>
    </main>

    <!-- FOOTER -->
    <footer class="bottom-bar">
        2026 propiskomat. Všechna práva vyhrazena.
    </footer>
<button id="admin-btn" class="admin-btn" style="display:none">Admin</button>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
<script>
    const SUPABASE_URL = "https://pgdtypgzzdchqefcgcaz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBnZHR5cGd6emRjaHFlZmNnY2F6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1MjAxNzEsImV4cCI6MjA3NDA5NjE3MX0.a0VHx01HJRa6G3MGTzR3pLHRjNr1cUiaiENOwWicizc";

    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const emailEl = document.getElementById("email");
    const token_countEl = document.getElementById("token_count");
    const btnQR = document.getElementById("generate-qr");
    const qrContainer = document.getElementById("qr-container");


    // === Funkce na generování temp key ===
    function generateTempKey(length = 48) {
        const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_-+=";
        let out = "";
        for (let i = 0; i < length; i++) out += chars.charAt(Math.floor(Math.random() * chars.length));
        return out;
    }

    // === Načtení uživatele + generování temporary_key ===
    let currentUserRow = null;

    async function loadUser() {
        const { data: userData } = await supabaseClient.auth.getUser();

        if (!userData.user) {
            window.location.href = "index.html";
            return;
        }

        const email = userData.user.email;
        emailEl.textContent = email;

        const newKey = generateTempKey();

        // --- najít uživatele podle emailu ---
        const { data: existing } = await supabaseClient
            .from("users")
            .select("id, token_count, temporary_key, admin")
            .eq("email", email)
            .maybeSingle();

        if (existing) {
            // update temporary_key
            await supabaseClient
                .from("users")
                .update({ temporary_key: newKey })
                .eq("email", email);

            currentUserRow = {
                id: existing.id,
                email: email,
                token_count: existing.token_count,
                temporary_key: newKey,
                admin: existing.admin
            };
        if (existing.admin === 1) {
                document.getElementById("admin-btn").style.display = "block";
            }
           
           
            token_countEl.textContent = existing.token_count;
            return;
        }

        // pokud neexistuje → vytvořit
        const { data: inserted } = await supabaseClient
            .from("users")
            .insert([{ 
                email: email, 
                temporary_key: newKey,
                admin: 0
            }])
            .select()
            .single();

        currentUserRow = inserted;
        token_countEl.textContent = inserted.admin;
    }

    loadUser();
    let qrTimeout = null;

    // === Generování QR kódu ===
    btnQR.addEventListener("click", async () => {

    if (!currentUserRow) {
        console.error("Uživatel ještě není načten!");
        return;
    }

    // Zrušíme případný starý timeout
    if (qrTimeout) {
        clearTimeout(qrTimeout);
        qrTimeout = null;
    }

    qrContainer.innerHTML = ""; // reset starého QR

    // Formát: id/temporary_key
    const qrData = currentUserRow.id + "/" + currentUserRow.temporary_key;

    // Vygenerování QR
    QRCode.toCanvas(qrData, { width: 220 }, (err, canvas) => {
        if (err) {
            console.error("Chyba QR:", err);
            return;
        }

        qrContainer.appendChild(canvas);

        // ⏱️ QR zmizí po 30 sekundách
        qrTimeout = setTimeout(() => {
            qrContainer.innerHTML = "";
            qrTimeout = null;
        }, 30000);
    });
    });
    /*
    // === Admin tlačítko ===
    const adminBtn = document.getElementById("admin-btn");


        
       document.addEventListener("DOMContentLoaded", async () => {
            const adminBtn = document.getElementById("admin-btn");
            adminBtn.style.display = "none"; // Výchozí stav: skryté
            const email = "08fililin@gmail.com";
            const admin = 1;
            if (admin === 1 && email === "08fililin@gmail.com") {
                adminBtn.style.display = "block"; // Zobrazit tlačítko, pokud je uživatel admin
            }

        
       document.addEventListener("DOMContentLoaded", async () => {
        // Načtení přihlášeného uživatele
        const { data: userData } = await supabaseClient.auth.getUser();
        if (!userData.user) {
            window.location.href = "index.html";
            return;
        }
        const email = userData.user.email;



        // Načtení údajů o uživateli z databáze
        const { data: existing } = await supabaseClient
            .from("users")
            .select("admin")
            .eq("email", email)
            .maybeSingle();

        // Pokud je admin true, zobrazit tlačítko
        if (existing?.admin) {
            adminBtn.style.display = "block";
        }
     });
            adminBtn.addEventListener("click", async () => {
              window.location.href = "admin.html";
    
    });

     */


</script> 



</body>
</html>
